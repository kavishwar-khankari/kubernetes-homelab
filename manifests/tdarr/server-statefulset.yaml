apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tdarr-server
  namespace: tdarr
spec:
  serviceName: tdarr-server
  replicas: 1
  selector:
    matchLabels:
      app: tdarr
      component: server
  template:
    metadata:
      labels:
        app: tdarr
        component: server
    spec:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"

      # Avoid scheduling on GPU node (leave RAM for worker)
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: intel.feature.node.kubernetes.io/gpu
                    operator: DoesNotExist

      containers:
      - name: tdarr-server
        image: ghcr.io/haveagitgat/tdarr:latest
        imagePullPolicy: IfNotPresent
        ports:
        - name: webui
          containerPort: 8265
        - name: server
          containerPort: 8266
        env:
        - name: TZ
          value: Asia/Kolkata
        - name: PUID
          value: "1000"
        - name: PGID
          value: "1000"
        - name: serverIP
          value: "0.0.0.0"
        - name: serverPort
          value: "8266"
        - name: webUIPort
          value: "8265"
        - name: internalNode
          value: "false"
        - name: inContainer
          value: "true"
        - name: ffmpegVersion
          value: "7"
        volumeMounts:
        - name: server
          mountPath: /app/server
        - name: configs
          mountPath: /app/configs
        - name: logs
          mountPath: /app/logs
        - name: media
          mountPath: /media
        resources:
          requests:
            memory: 512Mi
            cpu: 250m
          limits:
            memory: 6Gi
        startupProbe:
          httpGet:
            path: /api/v2/status
            port: 8265
          periodSeconds: 10
          failureThreshold: 35
        readinessProbe:
          httpGet:
            path: /api/v2/status
            port: 8265
          initialDelaySeconds: 10
          periodSeconds: 30
          failureThreshold: 4
        livenessProbe:
          httpGet:
            path: /api/v2/status
            port: 8265
          initialDelaySeconds: 30
          periodSeconds: 60
          failureThreshold: 4

      volumes:
      - name: media
        persistentVolumeClaim:
          claimName: tdarr-media2-media

  volumeClaimTemplates:
  - metadata:
      name: server
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: longhorn
      resources:
        requests:
          storage: 5Gi
  - metadata:
      name: configs
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: longhorn
      resources:
        requests:
          storage: 1Gi
  - metadata:
      name: logs
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: longhorn
      resources:
        requests:
          storage: 2Gi